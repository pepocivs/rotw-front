<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../general-style.html">

<dom-module id="component-items">
    <template>
      <style include="general-style iron-flex iron-flex-alignment">
        :host {
          display: block;
        }
        .item-container {
          background-color: #000000;
        }
        .item-box {
          background-color: #FFFFFF;
          width: 94px;
          height: 94px;
          margin: 5px;
          background-repeat: no-repeat;
          background-position: center;
          background-size: 77%;
          position: relative;
          padding: 5px;
        }
        .item-box.small {
          background-size: 60%;
          font-size: 10px;
        }
        .item-count {
          position: absolute;
          bottom: 0px;
        }
        #addByNumber {
          text-align: center;
        }
        #addByNumber div{
          margin: auto;
        }
      </style>

      <div class$="layout horizontal wrap center-center [[customClass]]">


        <template is="dom-if" if="[[isLink]]">
          <template is="dom-repeat" items="[[itemList]]">
              <div class="item-box small" on-tap="_goTo" value="{{item._id}}" style="background-image: url('{{item.image}}');">
                <div class="item-count">{{item.name}}</div>
              </div>
          </template>
        </template>

        <template is="dom-if" if="[[isTap]]">
          <template is="dom-repeat" items="[[itemList]]">
              <div class="item-box" on-tap="addElement" style="background-image: url('{{item.image}}');">
                <div class="item-count">x{{item.count}}</div>
              </div>
          </template>
        </template>

        <template is="dom-if" if="[[isDialog]]">
          <template is="dom-repeat" items="{{itemList}}">
              <div class="item-box"
                   on-tap="openDialog"
                   item="{{item}}"
                   style="background-image: url('{{item.image}}');">
                <div class="item-count">x{{item.count}}</div>
              </div>
          </template>
        </template>


        <paper-dialog id="addByNumber">
          <h2>Â¿Cuantos elementos de este tipo tienes?</h2>
          <div class="item-box" style="background-image: url('{{targetItem.image}}');"></div>
          <div>{{tempName}}</div>
          <paper-input type="number" value="{{tempCount}}"></paper-input>
          <paper-button on-tap="addElementByNumber"
                        item="{{targetItem}}">Agregar</paper-button>

        </paper-dialog>

      </div>

    </template>

    <script>
        Polymer({
          is: 'component-items',
          properties: {
            itemList: {
              type: Object,
              observer: '_formatItems'
            },
            inventory: {
              type: Object,
              notify: true
            },
            customClass: {
              type: String,
              value: 'item-container'
            },
            itemLimit: {
              type: Number,
              value: 0
            },
            isLink: {
              type: Boolean,
              value: false
            },
            goTo: {
              type: String,
              value: '',
              observer: '_isGoTo'
            },
            tap: {
              type: String,
              value: 'false',
              observer: '_isTap'
            }
          },
          _formatItems: function(response) {
              for (var x = 0; x < response.length; x++) {
                if (!response[x].count) response[x].count = 0;
              }
              this.itemList = response;
          },
          addElement: function(e) {
            var howMany = this.getTotalItems();
            if (this.itemLimit === 0 || howMany < this.itemLimit) {
              var model = e.model;
              model.set('item.count', model.item.count+1);
              this.inventory = this._cleanItems();
            }
          },
          addElementByNumber: function(e) {
            console.log(e.target);
            e.target.set('item.count', this.tempCount);
            // var element = searchById(this.itemList, this.tempId);
            // element.count = this.tempCount;
            // this.$['count'+this.tempId].value = 'pepo';
            // this.tempCount = 0;
            // this.tempId    = 0;

            this.inventory = this._cleanItems();
            this.$.addByNumber.close();
          },
          openDialog: function(e) {
            this.tempCount   = e.target.item.count;
            this.targetItem  = e.target.item;
            this.$.addByNumber.toggle();
          },
          _isTap: function() {
            this.isTap    = (this.tap === 'true' && !this.isLink);
            this.isDialog = (this.tap !== 'true' && !this.isLink);
          },
          _cleanItems: function() {
            var inventory = [];
            this.itemList.forEach(function(item) {
              if (item.count > 0) inventory.push({
                'itemId': item._id,
                'count': item.count,
                'image': item.image
              });
            });
            return inventory;
          },
          getTotalItems: function() {
            var count = 0;
            this.itemList.forEach(function(item) {
              count = count + item.count;
            });
            return count;
          },
          _isGoTo: function() {
              this.isLink = (this.goTo.length > 0);
          },
          _goTo: function(e) {
            console.log('GO TO: ', e.target.value);
            location.href = this.goTo+'?itemId='+e.target.value;
          }
        });
        function searchById (arrayData, id) {
          for (var i = 0; i < arrayData.length; i++) {
            if (+arrayData[i]._id == +id) {
              return arrayData[i];
            }
          }
          return null;
        }
    </script>
</dom-module>
