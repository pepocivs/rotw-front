<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../component-recipes/component-recipes.html">
<link rel="import" href="../component-infobar/component-infobar.html">

<dom-module id="btw-recipes">
    <template>
      <style>
        :host {
          display: block;
        }
      </style>
      <iron-ajax auto
      url="http://zelda.pepocivs.com/recipes"
      params="{{params}}"
      handle-as="json"
      last-response="{{recipesResponse}}"></iron-ajax>


      <template is="dom-if" if="[[showTitle(recipeList.available)]]">
        <component-infobar title="{{availableTitle}}"></component-infobar>
        <component-recipes recipe-list="[[recipeList.available]]"></component-recipes>
      </template>

      <template is="dom-if" if="[[showTitle(recipeList.possible)]]">
        <component-infobar title="{{possibleTitle}}"></component-infobar>
        <component-recipes recipe-list="[[recipeList.possible]]"></component-recipes>
      </template>

      <template is="dom-if" if="[[showTitle(recipeList.unavailable)]]">
        <component-infobar title="{{unavailableTitle}}"></component-infobar>
        <component-recipes recipe-list="[[recipeList.unavailable]]"></component-recipes>
      </template>

    </template>

    <script>
        Polymer({
            is: 'btw-recipes',
            properties: {
              recipesResponse: {
                type: Object,
                observer: '_recipesResponse'
              },
              params: {
                type: Object,
                value: {}
              }
            },
            ready: function() {
              this._getParams();
            },
            attributeChanged: function() {
              this._getParams();
            },
            _recipesResponse: function(response) {
              this.recipeList = response;
              if (this.recipeList.available.length === 1)
                this.availableTitle = "Puedes hacer esta receta";
              else
                this.availableTitle  = "Puedes hacer estas "+this.recipeList.available.length+" recetas";

              if (this.recipeList.possible.length === 1)
                this.possibleTitle = "Te falta algún ingrediente para hacer esta receta";
              else
                this.possibleTitle  = "Te falta algún ingrediente para hacer estas "+this.recipeList.possible.length+" recetas";

              if (this.recipeList.unavailable.length === 1)
                this.unavailableTitle = "No tienes ningún ingrediente para esta receta";
              else
                this.unavailableTitle  = "No tienes ningún ingrediente para hacer estas "+this.recipeList.unavailable.length+" recetas";
            },
            showTitle: function(list) {
              return (list.length > 0);
            },
            _getParams: function() {
              this.params = searchToObject();
            }
        });
        function searchToObject() {
          var pairs = window.location.search.substring(1).split("&"), obj = {}, pair, i;
          for ( i in pairs ) {
            if ( pairs[i] === "" ) continue;
            pair = pairs[i].split("=");
            obj[ decodeURIComponent( pair[0] ) ] = decodeURIComponent( pair[1] );
          }
          return obj;
        }
    </script>
</dom-module>
