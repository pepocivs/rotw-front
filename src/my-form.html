<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="general-style.html">
<!--
TODO:
Fix item counter each
Funcion de guardar con tratamiento de datos para API (counter)
Agregar todos los tipos de efectos (1/2 Corazon 1/4... etc)
-->
<dom-module id="my-form">
  <template>
    <div class="layout vertical" style="height:100%;">

      <style include="general-style iron-flex iron-flex-alignment">
        :host {
            display: block;
          }
      </style>

      <!-- AJAX CALLS -->
      <iron-ajax auto
                 url="http://zelda.pepocivs.com/items"
                 params='{}'
                 handle-as="json"
                 last-response="{{itemsResponse}}">
      </iron-ajax>
      <iron-ajax auto
                 url="http://zelda.pepocivs.com/food-img"
                 params='{}'
                 handle-as="json"
                 last-response="{{foodimgResponse}}">
      </iron-ajax>
      <iron-ajax auto
                 url="http://zelda.pepocivs.com/effects"
                 params='{}'
                 handle-as="json"
                 last-response="{{effectsResponse}}">
      </iron-ajax>
      <iron-ajax auto
                 url="http://zelda.pepocivs.com/crafting"
                 params='{}'
                 handle-as="json"
                 last-response="{{craftingResponse}}">
      </iron-ajax>

      <!-- DISHES MODAL -->
      <paper-dialog id="dish" style="position:absolute; height: 65%;">
        <div class="layout horizontal wrap center">
          <h2 class="flex">PLATO</h2>
          <paper-button dialog-confirm autofocus raised style="background-color:#2ecc71;color:white;font-weight:800;">Aceptar</paper-button>
        </div>

        <div class="layout horizontal wrap center justified">
          <div style="width:100%; text-align:right;"> {{nDish}}/1 </div>
          <div>Plato seleccionado</div>
          <div>
            <iron-icon src="{{dishImage}}"></iron-icon>
          </div>
        </div>

        <div class="layout horizontal wrap center-center form-box">
          <template is="dom-repeat" items="[[foodimgList]]" as="dish">
          <div on-tap="selectImage"
               value="{{dish._id}}"
               class="item-box-form"
               style="background-image: url('{{dish.image}}');"></div>
          </template>
        </div>
      </paper-dialog>

      <!-- INGREDIENTS MODAL -->
      <paper-dialog id="ingredients" style="position:absolute; height: 65%;">
        <div class="layout horizontal wrap center">
          <h2 class="flex">INGREDIENTES</h2>
          <paper-button dialog-confirm autofocus raised style="background-color:#2ecc71;color:white;font-weight:800;">Aceptar</paper-button>
        </div>

        <div class="layout horizontal wrap center justified">
          <div style="width:100%; text-align:right;"> {{nIngredients}}/5 </div>
          <div>Ingredientes seleccionados</div>
          <div>
            <template is="dom-repeat" items="{{data.ingredients}}" as="ingredient" index-as="x">
              <iron-icon on-tap="removeItem" value="{{ingredient._id}}" src="{{ingredient.image}}"></iron-icon>
            </template>
          </div>
        </div>

        <div class="layout horizontal wrap center-center form-box">
          <template is="dom-repeat" items="[[itemList]]">
            <div class="item-box-form"
                 style="background-image: url('{{item.image}}');"
                 on-tap="addItem"
                 value="{{item._id}}"
                 image="{{item.image}}">
              <div class="item-count">x{{item.count}}</div>
            </div>
          </template>
        </div>
      </paper-dialog>

      <!-- EFFECTS MODAL -->
      <paper-dialog id="effects" style="position:absolute; height: 65%;">
        <div class="layout horizontal wrap center">
          <h2 class="flex">EFECTOS</h2>
          <paper-button dialog-confirm autofocus raised style="background-color:#2ecc71;color:white;font-weight:800;">Aceptar</paper-button>
        </div>

        <div class="layout horizontal wrap center justified">
          <div style="width:100%; text-align:right;">-</div>
          <div>Efectos seleccionados</div>
          <div>
            <template is="dom-repeat" items="{{data.effects}}" as="effect" index-as="x">
              <iron-icon on-tap="removeEffect" value="{{effect._id}}" src="{{effect.icon}}"></iron-icon>
            </template>
          </div>
        </div>

        <div class="layout horizontal wrap center-center form-box">
          <template is="dom-repeat" items="[[effectsList]]" as="effect">
            <div class="item-box-form"
                 style="background-image: url('{{effect.icon}}');"
                 on-tap="addEffect"
                 value="{{effect._id}}"
                 icon="{{effect.icon}}">
            </div>
          </template>
        </div>
      </paper-dialog>

      <!-- FORM -->
      <div class="flex layout horizontal center-center box-initial" >
        <form is="iron-form" method="get" action="/" id="basic">
          <paper-input name="name"
                       label="Nombre de la receta"
                       value="{{data.name}}"
                       required></paper-input>

          <paper-textarea label="Descripción de la receta..."
                          value="{{data.description}}"></paper-textarea>

          <paper-button raised on-tap="toggleDishes">PLATO</paper-button>
          <paper-button raised on-tap="toggleIngredients">INGREDIENTES</paper-button>
          <paper-button raised on-tap="toggleEffects">EFECTOS</paper-button>

          <paper-dropdown-menu label="¿Como se hace?" name="craftingType" value="[[data.craftingType]]">
            <paper-menu attr-for-selected="value" class="dropdown-content" selected="{{data.craftingType}}">
              <template is="dom-repeat" items="[[craftingList]]" as="crafting">
                <paper-item on-tap="setCraftingIcon" icon="{{crafting.icon}}" value="{{crafting._id}}"><iron-icon src="{{crafting.icon}}"></iron-icon> {{crafting.type}}</paper-item>
              </template>
            </paper-menu>
          </paper-dropdown-menu>

          <paper-button raised on-tap="saveFunction">Guardar</paper-button>
          <paper-button raised on-tap="resetFunction">Reset</paper-button>
          <div class="output"></div>
        </form>
      </div>

      <!-- RESUME -->
      <div>
        <div class="layout horizontal wrap center-center form-inform-boxs">
          <div class="food-box layout horizontal nowrap center-center justified" >
            <div  style="width: 24%;margin-right: 9px;">
              <img src="{{dishImage}}" alt="{{data.name}}" class="foodprincipal">
            </div>
            <div class="food-box-one flex three  self-start">
              <p>{{data.name}}</p>
              <p>{{data.description}}</p>
              <template is="dom-repeat" items="{{data.effects}}" as="effect" index-as="x">
                <img src="{{effect.icon}}" value="{{effect._id}}" alt="" class="img-efects">
              </template>
            </div>
            <div class="v"></div>
            <div class="flex one food-box-two  self-start">
              <template is="dom-repeat" items="{{data.ingredients}}" as="ingredient" index-as="x">
                <img src="{{ingredient.image}}" value="{{ingredient._id}}" alt="" class="img-ingredients" />
              </template>
              <iron-icon src="{{craftingIcon}}"></iron-icon>
            </div>
          </div>
        </div>
      </div>

    </div>
  </template>


  <script>
    Polymer({
      is: 'my-form',
      properties: {
        data: {
          type: Object,
          notify: true
        },
        inventory: {
          type: Object
        },
        itemsResponse: {
          type: Object,
          observer: '_itemsResponse'
        },
        foodimgResponse: {
          type: Object,
          observer: '_foodimgResponse'
        },
        effectsResponse: {
          type: Object,
          observer: '_effectsResponse'
        },
        craftingResponse: {
          type: Object,
          observer: '_craftingResponse'
        },
        dishImage: {
          type: String,
          value: ""
        },
        nIngredients: {
          type: Number,
          value: 0
        },
        nDish: {
          type: Number,
          value: 0
        },
        craftingIcon: {
          type: String,
          value: "http://zelda.pepocivs.com/images/ic_fire.png"
        },
        itemCount: {
          type: Object
        }
      },
      ready: function() {
        this.resetFunction();
      },
      observers: [],
      _itemsResponse: function(response) {
        for (var i = 0; i < response.length; i++) {
          if (!response[i].count) response[i].count = 0;
        }
        this.itemList  = response;
      },
      _foodimgResponse: function(response) {
        this.foodimgList = response;
      },
      _effectsResponse: function(response) {
        this.effectsList = response;
      },
      _craftingResponse: function(response) {
        this.craftingList = response;
      },
      toggleIngredients: function() {
        this.$.ingredients.toggle();
      },
      toggleDishes: function() {
        this.$.dish.toggle();
      },
      toggleEffects: function() {
        this.$.effects.toggle();
      },
      _refreshIngredients: function(itm) {
        return itm * this.data.ingredients.length;
      },
      setCraftingIcon: function(e) {
        this.craftingIcon = e.target.icon;
      },
      selectImage: function(e) {
        this.data.image = e.target.value;
        this.dishImage  = "http://zelda.pepocivs.com/images/"+e.target.value+".png";
        this.nDish      = 1;
      },
      addItem: function(e) {
        var model = e.model;
        if(this.nIngredients < 5) {
          model.set('item.count', model.item.count+1);
          this.push('data.ingredients', {
            "_id": e.target.value,
            "image": e.target.image
          });
          this.nIngredients = this.data.ingredients.length;
        }
      },
      removeItem: function(e) {
        var removed = false;
        for (var i = 0; i < this.data.ingredients.length; i++) {
          if (e.target.value === this.data.ingredients[i]._id && !removed) {
            this.splice('data.ingredients', i, 1);
            removed = true;
          }
        }
        this.nIngredients = this.data.ingredients.length;
      },
      addEffect: function(e) {
        var model = e.model;
        this.push('data.effects', {
          "_id": e.target.value,
          "icon": e.target.icon
        });
      },
      removeEffect: function(e) {
        var removed = false;
        for (var i = 0; i < this.data.effects.length; i++) {
          if (e.target.value === this.data.effects[i]._id && !removed) {
            this.splice('data.effects', i, 1);
            removed = true;
          }
        }
        this.nIngredients = this.data.ingredients.length;
      },
      resetFunction: function(e) {
        this.nDish = 0;
        this.nIngredients = 0;
        this.data = {
          "name": "",
          "description": "",
          "image": "a100",
          "craftingType": 1,
          "ingredients": [],
          "effects": []
        }
      },
      saveFunction: function(e) {
        console.log(this.data);
      }
    });
  </script>
</dom-module>
